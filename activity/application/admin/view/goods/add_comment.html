<link rel="stylesheet" href="/template/mobile/rainbow/static/css/style.css">
<script src="/template/mobile/rainbow/static/js/jquery-3.1.1.min.js" type="text/javascript" charset="utf-8"></script>
<script type="text/javascript" src="__PUBLIC__/static/js/layer/layer.js"></script><!-- 弹窗js 参考文档 http://layer.layui.com/-->
<html data-dpr="2" style="font-size: 24px;">

<style>
    .excel_submit{
        font-size: 12px;
        line-height: 30px;
        font-weight: bold;
        color: #FFF;
        background-color: #48CFAE;
        display: block;
        height: 30px;
        padding: 0 20px;
        border-radius: 3px;
        border: none 0;
        cursor: pointer;
        margin: 10px;
    }
</style>
<!--顶部-s-->
    <div class="classreturn loginsignup">
        <div class="content" data-type="1" style="width:47%;background: #00a157;color: #F8F8F8;float: left">
            <div class="ds-in-bl search ">
                <span>评价晒单</span>
            </div>
        </div>
        <div class="content" data-type="2" style="width:47%;float: left">
            <div class="ds-in-bl search ">
                <span>导入评价</span>
            </div>
        </div>
    </div>

<form id="excel_import" method="post" action="{:U('Goods/excel_import')}" enctype="multipart/form-data" style="display: none">
    <input type="hidden" name="goods_id" value="{$order_goods['goods_id']}">
    <a href="/public/static/excel/评论导入模板.xlsx" style="text-decoration:none;">
        <input type="button" class="excel_submit" value="Excel模板下载">
    </a>
    <div style="width: 100%;height: 3rem;line-height: 3rem;">
        上传Excel文件：<input type="file" hidefocus="true" size="15" name="excel">
    </div>
        <!--<a class="submit_com" href="javascript:void(0);" style="color: #fff;display: block" onclick="excel_import(this)">提交</a>-->
        <input   style="margin-left: 5rem;border-color: #f23030;color: #f4f4f4;margin-bottom:1rem;width: 8rem;height: 1.5rem;line-height: 1.5rem;background: #f23030;text-align: center" type="submit" class="submit" value="导入">
</form>

<form id="add_comment" method="post" enctype="multipart/form-data">
<!--顶部-e-->
<!--评分-s-->
    <div class="sp_idear">
        <div class="maleri30">
            <img src="{$order_goods.goods_id|goods_thum_images=100,100}"/>
            <input type="hidden" name="is_virtual" value="{$order_goods['is_virtual']}">
            <div class="com_igy p">
                <p class="confine-wsp">{$order_goods.goods_name}</p>
                <p class="confine-wsp  shuxg">{$order_goods.spec_key_name}</p>
            </div>
        </div>
    </div>
<!--评分-e-->
<!--评论-s-->
    <div class="customer-messa comm_text_goods">
        <div class="maleri30">
            <textarea class="tapassa" onkeyup="checkfilltextarea('.tapassa','200')" d id="content_13" maxlength="200" name="content" placeholder="写下购买体会和使用感受来帮助其他小伙伴~"></textarea>
            <span class="xianzd"><em id="zero">200</em>/200</span>
        </div>
    </div>
<!--评论-e-->
<!--上传图片-s-->
    <div class="seravetype">
        <div class="maleri30">
            <ul id="imglen">
                <label>
                    <li class="file">
                        <div class="shcph" id="fileList0">
                            <img src="/template/mobile/rainbow/static/images/camera.png">
                        </div>
                        <input  type="file" accept="image/*" name="comment_img_file[]"  onchange="handleFiles(this,0)" style="display:none">
                    </li>
                </label>
                <label>
                    <li class="file">
                        <div class="shcph" id="fileList1">
                            <img src="/template/mobile/rainbow/static/images/camera.png">
                        </div>
                        <input  type="file" accept="image/*" name="comment_img_file[]"  onchange="handleFiles(this,1)" style="display:none">
                    </li>
                </label>
                <label>
                    <li class="file">
                        <div class="shcph" id="fileList2">
                            <img src="/template/mobile/rainbow/static/images/camera.png">
                        </div>
                        <input  type="file" accept="image/*" name="comment_img_file[]"  onchange="handleFiles(this,2)" style="display:none">
                    </li>
                </label>
                <label>
                    <li class="file">
                        <div class="shcph" id="fileList3">
                            <img src="/template/mobile/rainbow/static/images/camera.png">
                        </div>
                        <input  type="file" accept="image/*" name="comment_img_file[]"  onchange="handleFiles(this,3)" style="display:none">
                    </li>
                </label>
                <label>
                    <li class="file">
                        <div class="shcph" id="fileList4">
                            <img src="/template/mobile/rainbow/static/images/camera.png">
                        </div>
                        <input  type="file" accept="image/*" name="comment_img_file[]"  onchange="handleFiles(this,4)" style="display:none">
                    </li>
                </label>
            </ul>
            <div class="inspectrepot p">
                <div class="radio">
                    <span class="che" >
                        <span>名称：</span>
                        <input type="text" name="hide_username"id="hide_username" placeholder="留空为匿名" >
                    </span>
                </div>
            </div>
        </div>
    </div>
<!--上传图片-e-->
<!--服务评价-s-->
    <div class="wlcomenser ma-to-20">
        <div class="maleri30">
            <div class="p_zyft p">
                <p class="fl">评分</p>
                <p class="fr lifi">满意请给5分哦</p>
            </div>
        </div>
    </div>
    <div class="thirs_commen jsstar">
        <div class="maleri30">
            <div class="al_comentaid p">
                <div class="taidh">商品符合度</div>
                <div class="star_click">
                   <span class="comment-item-star_wr" title="1">
                        <span class="real-star_wr" ></span>
                    </span>
                    <span class="comment-item-star_wr" title="2">
                        <span class="real-star_wr" ></span>
                    </span>
                    <span class="comment-item-star_wr" title="3">
                        <span class="real-star_wr" ></span>
                    </span>
                    <span class="comment-item-star_wr" title="4">
                        <span class="real-star_wr" ></span>
                    </span>
                    <span class="comment-item-star_wr" title="5">
                        <span class="real-star_wr" ></span>
                    </span>
                    <input name="goods_rank" value="0" type="hidden">
                </div>
            </div>
            <div class="al_comentaid p">
                <div class="taidh">店家服务态度</div>
                <div class="star_click">
                    <span class="comment-item-star_wr" title="1">
                        <span class="real-star_wr" ></span>
                    </span>
                    <span class="comment-item-star_wr" title="2">
                        <span class="real-star_wr" ></span>
                    </span>
                    <span class="comment-item-star_wr" title="3">
                        <span class="real-star_wr" ></span>
                    </span>
                    <span class="comment-item-star_wr" title="4">
                        <span class="real-star_wr" ></span>
                    </span>
                    <span class="comment-item-star_wr" title="5">
                        <span class="real-star_wr" ></span>
                    </span>
                    <input name="service_rank" value="0" type="hidden">
                </div>
            </div>
            <if condition="$order_info['prom_type'] neq 5">
                <div class="al_comentaid p">
                <div class="taidh">物流发货速度</div>
                <div class="star_click">
                    <span class="comment-item-star_wr" title="1">
                        <span class="real-star_wr"  ></span>
                    </span>
                    <span class="comment-item-star_wr" title="2">
                        <span class="real-star_wr"  ></span>
                    </span>
                    <span class="comment-item-star_wr" title="3">
                        <span class="real-star_wr"  ></span>
                    </span>
                    <span class="comment-item-star_wr" title="4">
                        <span class="real-star_wr"  ></span>
                    </span>
                    <span class="comment-item-star_wr" title="5">
                        <span class="real-star_wr"  ></span>
                    </span>
                    <input name="deliver_rank" value="0" type="hidden">
                </div>
            </div>
            </if>
        </div>
    </div>
<!--服务评价-e-->
    <input type="hidden" name="order_id" value="{$order_goods.order_id}">
    <input type="hidden" name="goods_id" value="{$order_goods.goods_id}">
    <input type="hidden" name="item_id" value="{$order_goods.item_id}">
    <div class="ds-in-bl menu" style="margin-left: 5rem;margin-bottom:1rem;width: 8rem;height: 1.5rem;line-height: 1.5rem;background: #f23030;text-align: center">
        <a class="submit_com" href="javascript:void(0);" style="color: #fff;display: block" onclick="validate_comment(this)">提交</a>
    </div>
</form>
<script type="text/javascript">
    $(".content").click(function(){
       $('.content').css('background','#F8F8F8');
       $('.content').css('color','#000');
        $(this).css('background','#00a157');
        $(this).css('color','#fff');
        if($(this).attr('data-type') == 1){
            $('#add_comment').show();
            $('#excel_import').hide();
        }
        if($(this).attr('data-type') == 2){
            $('#add_comment').hide();
            $('#excel_import').show();
        }
    });
    /**
     * 留言字数限制
     * tea ：要限制数字的class名
     * nums ：允许输入的最大值
     * zero ：输入时改变数值的ID
     */
    function checkfilltextarea(tea,nums){
        var len = $(tea).val().length;
        if(len > nums){
            $(tea).val($(tea).val().substring(0,nums));
        }
        var num = nums - len;
        num <= 0 ? $("#zero").text(0): $("#zero").text(num);  //防止出现负数
    }
    $(function(){
        var is_virtual = $("input[name='is_virtual']").val();
        if(is_virtual == 1){
            $("input[name='deliver_rank']").val(5);
            $('.al_comentaid').eq(2).css('display','none');
        }
        $(".jsstar input").val('');
        //评分
        $('.comment-item-star_wr').click(function(e){
            var obj = $(this);
            obj.find('span').addClass('comment-stars-width5');
            obj.prevAll().find('span').addClass('comment-stars-width5').parent();
            obj.nextAll().find('span').removeClass('comment-stars-width5');
            obj.siblings('input').val(obj.attr('title'));
        })
    })


    function validate_comment(obj){
        $(obj).attr('disabled',true);
        var content = $("#content_13").val();
        var error = [];
        var img_num = 0;
        var AllImgExt=".jpg|.jpeg|.gif|.bmp|.png|";//全部图片格式类型
        $(".file input").each(function(index){
            FileExt = this.value.substr(this.value.lastIndexOf(".")).toLowerCase();
            if(this.value!=''){
                img_num++;
                if(AllImgExt.indexOf(FileExt+"|")==-1){
                    error.push("第"+(index+1)+"张图片格式错误");
                }
            }
        });
        var is_virtual = $("input[name='is_virtual']").val();
        if(is_virtual == 1){
            $("input[name='deliver_rank']").val(5);
        }
        $(".jsstar input").each(function(index,e){
            if(e.value == '0' || e.value == ''){
                if(e.name == 'goods_rank'){
                    error.push('请给描述评分！');
                };
                if(e.name == 'service_rank'){
                    error.push('请给服务评分！');
                };
                if(e.name == 'deliver_rank'){
                    error.push('请给物流评分！');
                };
            }
        });
        if(content == ''){
            error.push('请填写评价内容');
        }
        if(content.length < 10){
            error.push('评论内容最少10个字符');
        }
        if(content.length>500){
            error.push('评价内容长度超过限制');
        }

        if(error.length>0){
            $(obj).attr('disabled',false);
            layer.alert(error[0], {icon: 2});
            return false;
        }else{
            // var formObj = document.getElementById("add_comment");
            var formData = new FormData();//表单id
            $('#add_comment').find('input').each(function () {
                if($(this).attr('name')=='comment_img_file[]'){
                    formData.append('comment_img_file[]', $(this)[0].files[0]);
                }else{
                    formData.append($(this).attr('name'), $(this).val());
                }
            })
            formData.append("content", $("textarea[name='content']").val());
            console.log(formData);
            $.ajax({
                type: "POST",
                url: "{:U('Admin/Goods/add_comment')}",
                data: formData,
                dataType: "json",
                async: false,
                cache: false,  //上传文件不需要缓存
                contentType: false,
                processData: false, //因为data值是FormData对象，不需要对数据做处理
                error: function (data) {
                    alert(JSON.stringify(data));
                    layer.alert("服务器繁忙, 请联系管理员!", {icon: 2});
                },
                success: function (data) {
                    if (data.status == 1) {
                        layer.alert(data.msg, {icon: 1});
                        setTimeout(function () {
                            parent.layer.closeAll();
                        },1000);
                    }else {
                        layer.alert(data.msg, {icon: 2});
                    }
                }
            });
        }
    }

    //显示上传照片
    window.URL = window.URL || window.webkitURL;
    function handleFiles(obj,id) {
        fileList = document.getElementById("fileList"+id);
        var files = obj.files;
        img = new Image();
        if(window.URL){

            img.src = window.URL.createObjectURL(files[0]); //创建一个object URL，并不是你的本地路径
            img.width = 60;
            img.height = 60;
            img.onload = function(e) {
                window.URL.revokeObjectURL(this.src); //图片加载后，释放object URL
            }
            if(fileList.firstElementChild){
                fileList.removeChild(fileList.firstElementChild);
            }
            fileList.appendChild(img);
        }else if(window.FileReader){
            //opera不支持createObjectURL/revokeObjectURL方法。我们用FileReader对象来处理
            var reader = new FileReader();
            reader.readAsDataURL(files[0]);
            reader.onload = function(e){
                img.src = this.result;
                img.width = 60;
                img.height = 60;
                fileList.appendChild(img);
            }
        }else
        {
            //ie
            obj.select();
            obj.blur();
            var nfile = document.selection.createRange().text;
            document.selection.empty();
            img.src = nfile;
            img.width = 60;
            img.height = 60;
            img.onload=function(){

            }
            fileList.appendChild(img);
        }
    }
</script>
</body>
</html>
